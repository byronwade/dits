# Dits Development Commands
# Install just: cargo install just
# Usage: just <recipe>

# Default recipe - show available commands
default:
    @just --list

# ============================================================================
# Testing
# ============================================================================

# Run all tests (Rust + integration)
test-all: test test-integration

# Run integration tests only
test-integration:
    cd t && ./run-tests.sh

# Run integration tests with verbose output
test-integration-verbose:
    cd t && ./run-tests.sh -v

# Run integration tests in parallel
test-integration-parallel:
    cd t && ./run-tests.sh --prove

# Run performance tests
test-performance:
    cd t/perf && ../run-tests.sh

# Validate test script quality with chainlint
test-chainlint:
    cd t && find . -name "t[0-9][0-9][0-9][0-9]*.sh" -exec sh -c 'CHAINLINT_FILE="$1" perl chainlint.pl' _ {} \;

# ============================================================================
# Development
# ============================================================================

# Build all crates
build:
    cargo build --all-targets

# Build in release mode
build-release:
    cargo build --release --all-targets

# Run all tests
test:
    cargo nextest run 2>/dev/null || cargo test

# Run shell script integration tests
test-integration:
    cd t && ./run-tests.sh

# Run shell script tests with verbose output
test-integration-verbose:
    cd t && ./run-tests.sh -v

# Run shell script tests in parallel (if prove is available)
test-integration-parallel:
    cd t && ./run-tests.sh --prove

# Run performance tests
test-performance:
    cd t/perf && ../run-tests.sh

# Run chainlint validation
test-chainlint:
    cd t && find . -name "t[0-9][0-9][0-9][0-9]*.sh" -exec perl chainlint.pl {} \;

# Run specific test suite
test-suite suite:
    cd t && ./run-tests.sh -r "{{suite}}"

# Run FastCDC comprehensive tests
test-fastcdc:
    cd t && ./run-tests.sh -r "core/t0100"

# Run video comprehensive tests
test-video:
    cd t && ./run-tests.sh -r "core/t0200"

# Run file types comprehensive tests
test-filetypes:
    cd t && ./run-tests.sh -r "core/t0300"

# Run edge cases and error tests
test-edge-cases:
    cd t && ./run-tests.sh -r "qa/t0400"

# Run concurrent access tests
test-concurrent:
    cd t && ./run-tests.sh -r "qa/t0500"

# Run data integrity tests
test-integrity:
    cd t && ./run-tests.sh -r "qa/t0600"

# Run extreme stress tests
test-stress:
    cd t && ./run-tests.sh -r "qa/t0700"

# Run security tests
test-security:
    cd t && ./run-tests.sh -r "qa/t0800"

# Run workflow simulations
test-workflows:
    cd t && ./run-tests.sh -r "advanced/t0900"

# Run P2P networking tests
test-p2p:
    cd t && ./run-tests.sh -r "advanced/t1000"

# Run storage lifecycle tests
test-lifecycle:
    cd t && ./run-tests.sh -r "advanced/t1100"

# Run audit and compliance tests
test-audit:
    cd t && ./run-tests.sh -r "advanced/t1200"

# ============================================================================
# NEW COMPREHENSIVE TESTS
# ============================================================================

# Run cross-platform compatibility tests
test-cross-platform:
    cd t && ./run-tests.sh -r "qa/t1300"

# Run network failure and interruption tests
test-network-failures:
    cd t && ./run-tests.sh -r "qa/t1400"

# Run long-term repository aging tests
test-aging:
    cd t && ./run-tests.sh -r "qa/t1500"

# Run massive concurrency tests (1TB workload simulation)
test-massive-concurrency:
    cd t && ./run-tests.sh -r "qa/t1600"

# ============================================================================
# CREATIVE ASSETS TESTING
# ============================================================================

# Run comprehensive creative assets tests
test-creative-assets:
    cd t && ./run-tests.sh -r "core/t0301"

# Run Git recovery tests for creative assets
test-git-recovery-creative:
    cd t && ./run-tests.sh -r "qa/t1700"

# Run all creative industry tests
test-creative-all: test-creative-assets test-git-recovery-creative

# Run all new comprehensive QA tests
test-qa-extended: test-cross-platform test-network-failures test-aging test-massive-concurrency test-creative-all

# Run tests for a specific crate
test-crate crate:
    cargo test -p {{crate}}

# Run tests with coverage
coverage:
    cargo tarpaulin --out Html --output-dir target/coverage

# Run clippy lints
lint:
    cargo clippy --all-targets --all-features -- -D warnings

# Format code
fmt:
    cargo fmt --all

# Check formatting
fmt-check:
    cargo fmt --all -- --check

# Full check (build + test + lint + fmt)
check: fmt-check lint test
    @echo "All checks passed!"

# Watch for changes and run tests
watch:
    cargo watch -x test

# Watch for changes and run clippy
watch-lint:
    cargo watch -x clippy

# ============================================================================
# Documentation
# ============================================================================

# Generate and open documentation
docs:
    cargo doc --no-deps --open

# Build all documentation
docs-all:
    cargo doc --all-features --document-private-items

# Serve documentation locally
docs-serve:
    cd target/doc && python3 -m http.server 8080

# ============================================================================
# Database
# ============================================================================

# Start local database
db-start:
    docker-compose up -d postgres redis

# Stop local database
db-stop:
    docker-compose down

# Run database migrations
db-migrate:
    cargo run --bin dits-migrate

# Reset database (WARNING: destructive)
db-reset:
    docker-compose down -v
    docker-compose up -d postgres redis
    sleep 3
    cargo run --bin dits-migrate

# Connect to local database
db-connect:
    psql postgresql://dits:dits@localhost:5432/dits

# ============================================================================
# Server
# ============================================================================

# Run API server
server:
    cargo run --bin dits-server

# Run API server in watch mode
server-watch:
    cargo watch -x 'run --bin dits-server'

# Run API server in release mode
server-release:
    cargo run --release --bin dits-server

# ============================================================================
# CLI
# ============================================================================

# Run CLI command
cli *args:
    cargo run --bin dits -- {{args}}

# Install CLI locally
cli-install:
    cargo install --path crates/dits-client

# ============================================================================
# Benchmarks
# ============================================================================

# Run all benchmarks
bench:
    cargo bench

# Run specific benchmark
bench-name name:
    cargo bench -- {{name}}

# Run benchmarks and compare to baseline
bench-compare:
    cargo bench -- --save-baseline new
    critcmp baseline new

# ============================================================================
# Release
# ============================================================================

# Check if ready for release
release-check:
    cargo publish --dry-run -p dits-core
    cargo publish --dry-run -p dits-parsers
    cargo publish --dry-run -p dits-storage
    cargo publish --dry-run -p dits-protocol
    cargo publish --dry-run -p dits-sdk

# Build release binaries
release-build:
    cargo build --release
    @echo "Binaries in target/release/"

# ============================================================================
# Docker
# ============================================================================

# Build Docker image
docker-build:
    docker build -t dits:latest .

# Run in Docker
docker-run:
    docker-compose up

# Build and push Docker image
docker-push tag:
    docker build -t dits:{{tag}} .
    docker push dits:{{tag}}

# ============================================================================
# Utilities
# ============================================================================

# Clean build artifacts
clean:
    cargo clean

# Update dependencies
update:
    cargo update

# Check for outdated dependencies
outdated:
    cargo outdated

# Security audit
audit:
    cargo audit

# Count lines of code
loc:
    tokei --exclude target --exclude node_modules

# Generate dependency graph
deps-graph:
    cargo depgraph | dot -Tpng > deps.png
    @echo "Generated deps.png"

# ============================================================================
# CI Helpers
# ============================================================================

# Run full CI check locally
ci: fmt-check lint test audit
    @echo "CI checks passed!"

# Generate lockfile
lockfile:
    cargo generate-lockfile

# Verify minimum Rust version
msrv:
    cargo msrv --min 1.75.0
